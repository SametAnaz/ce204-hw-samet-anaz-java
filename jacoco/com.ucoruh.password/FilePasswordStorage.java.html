<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FilePasswordStorage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">password-app</a> &gt; <a href="index.source.html" class="el_package">com.ucoruh.password</a> &gt; <span class="el_source">FilePasswordStorage.java</span></div><h1>FilePasswordStorage.java</h1><pre class="source lang-java linenums">package com.ucoruh.password;

import java.io.*;
import java.util.*;

/**
 * @brief Implementation of InterfacePasswordStorage using file-based storage.
 *
 * This class provides file-based operations to store, retrieve, update, and delete password entries.
 * All password data is encrypted using the master password.
 */
public class FilePasswordStorage implements InterfacePasswordStorage {
	/**
	 * @brief File name used for file-based password storage.
	 *
	 * This static final field holds the file name where password entries are stored 
	 * when using a file-based storage mechanism.
	 */
	private static final String FILE = &quot;passwords.txt&quot;;
	
	/**
	 * @brief The master password used for encryption/decryption.
	 */
	private final String masterPassword;
	
	/**
	 * @brief Constructor that initializes storage with the master password.
	 * 
	 * @param masterPassword The master password for encryption/decryption.
	 */
<span class="fc" id="L31">	public FilePasswordStorage(String masterPassword) {</span>
<span class="fc" id="L32">		this.masterPassword = masterPassword;</span>
<span class="fc" id="L33">	}</span>

	/**
	 * @brief Adds a new password entry to the file-based storage.
	 *
	 * This method prompts the user to enter the service, username, and password, then creates a Password
	 * object and appends its details to the passwords file.
	 *
	 * @param scanner the Scanner object used to obtain user input.
	 */
	@Override
	public void add(Scanner scanner) {
<span class="fc" id="L45">		System.out.print(&quot;Service: &quot;);</span>
<span class="fc" id="L46">		String service = scanner.nextLine();</span>
<span class="fc" id="L47">		System.out.print(&quot;Username: &quot;);</span>
<span class="fc" id="L48">		String user = scanner.nextLine();</span>
<span class="fc" id="L49">		System.out.print(&quot;Password: &quot;);</span>
<span class="fc" id="L50">		String pass = scanner.nextLine();</span>

<span class="fc" id="L52">		Password p = new Password(service, user, pass);</span>
<span class="fc" id="L53">		List&lt;Password&gt; passwords = readAll();</span>
		
		// Check if service already exists
<span class="fc" id="L56">		boolean exists = passwords.stream()</span>
<span class="fc" id="L57">			.anyMatch(pwd -&gt; pwd.getService().equalsIgnoreCase(service));</span>
		
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (exists) {</span>
<span class="nc" id="L60">			System.out.println(&quot;A password for this service already exists. Use update option to modify it.&quot;);</span>
<span class="nc" id="L61">			return;</span>
		}
		
<span class="fc" id="L64">		passwords.add(p);</span>
<span class="fc" id="L65">		writeAll(passwords);</span>
<span class="fc" id="L66">		System.out.println(&quot;Password saved successfully.&quot;);</span>
<span class="fc" id="L67">	}</span>

	/**
	 * @brief Displays all stored password entries.
	 *
	 * This method reads all password entries from the file and prints them to the console.
	 */
	@Override
	public void view() {
<span class="fc" id="L76">		List&lt;Password&gt; list = readAll();</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">		if (list.isEmpty()) {</span>
<span class="fc" id="L78">			System.out.println(&quot;No records found.&quot;);</span>
		} else {
<span class="fc bfc" id="L80" title="All 2 branches covered.">			for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="fc" id="L81">				System.out.println((i + 1) + &quot;. &quot; + list.get(i));</span>
			}
		}
<span class="fc" id="L84">	}</span>

	/**
	 * @brief Updates an existing password entry.
	 *
	 * This method prompts the user for the service to update and, if found, updates its username and password.
	 *
	 * @param scanner the Scanner object used to obtain user input for the update.
	 */
	@Override
	public void update(Scanner scanner) {
<span class="fc" id="L95">		List&lt;Password&gt; list = readAll();</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">		if (list.isEmpty()) {</span>
<span class="fc" id="L97">			System.out.println(&quot;No records found.&quot;);</span>
<span class="fc" id="L98">			return;</span>
		}
		
<span class="fc" id="L101">		System.out.print(&quot;Service to update: &quot;);</span>
<span class="fc" id="L102">		String target = scanner.nextLine();</span>
<span class="fc" id="L103">		boolean updated = false;</span>

<span class="fc bfc" id="L105" title="All 2 branches covered.">		for (Password p : list) {</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">			if (p.getService().equalsIgnoreCase(target)) {</span>
<span class="fc" id="L107">				System.out.print(&quot;New username (leave blank to keep current '&quot; + p.getUsername() + &quot;'): &quot;);</span>
<span class="fc" id="L108">				String username = scanner.nextLine();</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">				if (!username.trim().isEmpty()) {</span>
<span class="fc" id="L110">					p.setUsername(username);</span>
				}
				
<span class="fc" id="L113">				System.out.print(&quot;New password (leave blank to keep current): &quot;);</span>
<span class="fc" id="L114">				String password = scanner.nextLine();</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">				if (!password.trim().isEmpty()) {</span>
<span class="fc" id="L116">					p.setPassword(password);</span>
				}
				
<span class="fc" id="L119">				updated = true;</span>
<span class="fc" id="L120">				break;</span>
			}
<span class="fc" id="L122">		}</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">		if (updated) {</span>
<span class="fc" id="L125">			writeAll(list);</span>
<span class="fc" id="L126">			System.out.println(&quot;Password updated successfully.&quot;);</span>
		} else {
<span class="fc" id="L128">			System.out.println(&quot;Service not found.&quot;);</span>
		}
<span class="fc" id="L130">	}</span>

	/**
	 * @brief Deletes a password entry from the file-based storage.
	 *
	 * This method prompts the user for the service name of the entry to delete and removes the entry from the file.
	 *
	 * @param scanner the Scanner object used to obtain user input for deletion.
	 */
	@Override
	public void delete(Scanner scanner) {
<span class="fc" id="L141">		List&lt;Password&gt; list = readAll();</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">		if (list.isEmpty()) {</span>
<span class="fc" id="L143">			System.out.println(&quot;No records found.&quot;);</span>
<span class="fc" id="L144">			return;</span>
		}
		
<span class="fc" id="L147">		System.out.print(&quot;Service to delete: &quot;);</span>
<span class="fc" id="L148">		String target = scanner.nextLine();</span>
<span class="fc" id="L149">		boolean removed = list.removeIf(p -&gt; p.getService().equalsIgnoreCase(target));</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">		if (removed) {</span>
<span class="fc" id="L152">			writeAll(list);</span>
<span class="fc" id="L153">			System.out.println(&quot;Password deleted successfully.&quot;);</span>
		} else {
<span class="fc" id="L155">			System.out.println(&quot;Service not found.&quot;);</span>
		}
<span class="fc" id="L157">	}</span>

	/**
	 * @brief Reads all password entries from the file.
	 *
	 * This method opens the file and reads each line, decrypts the data,
	 * and converts it into Password objects. All valid entries are returned as a list.
	 *
	 * @return a List of Password objects representing the stored password entries.
	 */
	@Override
	public List&lt;Password&gt; readAll() {
<span class="fc" id="L169">		List&lt;Password&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L170">		File file = new File(FILE);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">		if (!file.exists()) {</span>
<span class="fc" id="L172">			return list;</span>
		}
		
<span class="fc" id="L175">		try (BufferedReader reader = new BufferedReader(new FileReader(file))) {</span>
			String line;
<span class="fc bfc" id="L177" title="All 2 branches covered.">			while ((line = reader.readLine()) != null) {</span>
				try {
					// Decrypt the line
<span class="fc" id="L180">					String decrypted = EncryptionUtil.decrypt(line, masterPassword);</span>
<span class="fc" id="L181">					String[] parts = decrypted.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">					if (parts.length == 3) {</span>
<span class="fc" id="L183">						list.add(new Password(parts[0], parts[1], parts[2]));</span>
					}
<span class="fc" id="L185">				} catch (Exception e) {</span>
					// Skip lines that cannot be decrypted
<span class="fc" id="L187">					System.out.println(&quot;Warning: Could not decrypt a password entry.&quot;);</span>
<span class="fc" id="L188">				}</span>
			}
<span class="nc" id="L190">		} catch (IOException e) {</span>
<span class="nc" id="L191">			System.out.println(&quot;Error reading password file: &quot; + e.getMessage());</span>
<span class="fc" id="L192">		}</span>
<span class="fc" id="L193">		return list;</span>
	}

	/**
	 * @brief Writes the list of password entries to the file.
	 *
	 * This method clears the existing content of the file and writes all password entries
	 * from the provided list, encrypting each entry.
	 *
	 * @param list a List of Password objects to be written to the file.
	 */
	@Override
	public void writeAll(List&lt;Password&gt; list) {
<span class="fc" id="L206">		try (BufferedWriter writer = new BufferedWriter(new FileWriter(FILE))) {</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">			for (Password p : list) {</span>
<span class="fc" id="L208">				String data = p.getService() + &quot;,&quot; + p.getUsername() + &quot;,&quot; + p.getPassword();</span>
				try {
					// Encrypt the data
<span class="fc" id="L211">					String encrypted = EncryptionUtil.encrypt(data, masterPassword);</span>
<span class="fc" id="L212">					writer.write(encrypted);</span>
<span class="fc" id="L213">					writer.newLine();</span>
<span class="nc" id="L214">				} catch (Exception e) {</span>
<span class="nc" id="L215">					System.out.println(&quot;Error encrypting password for &quot; + p.getService() + &quot;: &quot; + e.getMessage());</span>
<span class="fc" id="L216">				}</span>
<span class="fc" id="L217">			}</span>
<span class="fc" id="L218">		} catch (IOException e) {</span>
<span class="fc" id="L219">			System.out.println(&quot;Error writing to password file: &quot; + e.getMessage());</span>
<span class="fc" id="L220">		}</span>
<span class="fc" id="L221">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>